# Chpater 14 Link Initialization & Training//链路初始化与训练

### 关于前一章

上一章描述了物理层电与链路的电气接口，包括差分发送器与接收器的一些底层特性。同时也讨论了信号均衡的需求以及均衡的方法。上一章中分别讨论了 Gen1, Gen2 和 Gen3 速度等级下的差分发送与接收器的特性。

### 关于本章 

 本章讨论物理层链路训练与状态状态机（LTSSM, Link Traning and Status State Machine）的行为，包括从上电开始，到正常报文流量开始的整个初始化过程。此外，本章还将讨论链路电源状态 L0s,L1,L2,L3 以及这些状态之间的转换。本章也会讨论恢复机制（Recovery），重新完成位锁定（Bit Lock）、符号锁定（Symbol Lock）或者块锁定（Block Lock）的过程。最后，还讨论了用于链路带宽管理的链路速率以及位宽转换。

### 关于下一章

下一章将讨论 PCIe 端口或者链路中存在的错误类型，如何检测、报告这些错误，以及这些错误的处理选项。因为 PCIe 设计中后向兼容了 PCI 的错误报告机制，所以将介绍 PCI 的错误处理机制作为背景知识。然后我们将关注于PCIe 对于可纠正、非致命以及致命错误的处理机制。

### 14.1 总览

链路初始化和训练是由物理层控制的，基于硬件 (而非软件) 的过程。该过程配置和初始化设备的链路和端口，使链路上能够进行正常的数据报文通信。

![图 14-1 LTSSM 所处的位置](img/14%20%E9%93%BE%E8%B7%AF%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%8E%E8%AE%AD%E7%BB%83/image-20211221215807738.png)

完整的训练过程在复位后由硬件自动启动，并由 LTSSM 管理，如 506 页图14-1 所示。在链路初始化和训练过程中包括了几项步骤。让我们思考下它们都有哪些作用，并提前引入一些术语。

- **位锁定，Bit Lock**：当链路训练开始时，接收器的时钟尚未与接收信号的发送时钟同步，无法可靠地采样输入信号的数据比特。在链路训练期间，接收器的**时钟和数据恢复**（CDR，Clock and Data Recovery）逻辑通过使用数据比特流作为时钟的参考信号，来重建发送器的时钟。一旦从数据流中恢复了时钟，就可以说接收器已经完成了位锁定，然后能够正确地采样输入数据比特。有关位锁定机制的更多信息，可以参阅第 395 页的“实现位锁定”。

- **符号锁定，Symbol Lock**：对于8b/10b编码 (Gen1/Gen2)而言，训练的下一步是进行符号锁定。同位锁定类似，虽然接收器目前可以识别单个比特的极性，但是不知道由 10 个比特组成的，符号的边界在哪里。当发送接收端的 TS1 和 TS2 字符序列进行交换时，接收器在比特流中搜索可识别的符号。COM 符号是用符号识别目的的一个简单符号。COM 符号独特的编码使得它很容易识别，在 TS1 和 TS2 字符序列的交换过程中，COM 字符到达并被识别后，意味着接收方定位到了两个符号之间的边界，以及两个字符序列之间的边界。有关这方面的更多信息，参见第 396 页的“实现符号锁定”。

- **块锁定，Block Lock**：对于8.0 GT/s(Gen3) 所使用的块锁定，处理过程与符号锁定略有不同，因为没有使用8b/10b 编码方案，所以也就不存在 COM 字符。然而，接收器仍然需要在接收比特流中找到可识别的报文边界。解决方案是在训练字符序列中包含更多的电气空闲退出字符序列（ EIEOS,Electrical Idle Exit Ordered Set)，用于定位边界。EIEOS 可以被识别为 00h 和 FFh 字节交替的字符序列，并且其位置定义了块之间的边界，因为根据协议，当该字符序列结束时，下一个块必须开始。

- **链路宽度，Link Width**：具有多个通道的 PCIe 设备可以使用不同的链路宽度。例如，具有 x2 端口的设备可以与 x4 端口的设备连接。在链路训练期间，两台设备的物理层会测试链路，并将链路宽度设置为两者能接受的最大值。

- **通道反转， Lane Reversal**：设备端口上的多个通道从 0 开始，按递增顺序编号。通常来说，端口的通道 0 同样连接到对端的通道 0，通道 1 连接到通道 1 ，依此类推。

  然而，有时我们希望能够在逻辑上，颠倒各个通道间的编号，以简化 PCB 布线。并且能够允许各个通道间的连接走线不必交叉(参见第 508 页的图 14-2)。只要其中一个 PCIe 设备支持通道编号反转功能，这是一项可选功能，就可以颠倒通道的连接关系。

  通道连接颠倒的情况是在链路训练期间检测到的，其后，其中一台设备必须在内部颠倒其通道编号才能使链路正常工作。由于规范没有强制要求支持此功能，电路板设计人员需要保证系统中至少有一个设备支持此功能，才能颠倒通道顺序布线。

![image-20211221225619507](img/14%20%E9%93%BE%E8%B7%AF%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%8E%E8%AE%AD%E7%BB%83/image-20211221225619507.png)

- **链路数据速率，Link Data Rate**: 在完成复位操作后，链路初始化与训练状态机总是会先将数据速率设置为默认的 2.5Gbit/s，以实现对第一代协议的后向兼容（第一代协议速率为  2.5Gbit/s）。如果链路宣称可以实现更高的速率，那么在完成低速率训练后，LSTTM 会自动在初始化阶段，重新进行一次过程更短的，但速率配置（比如 5/8/16/32/64Gbps）更高的训练，尝试将链路配置为最高速率。

- **多 lane 间信号偏移补偿，Lane‐to‐Lane De‐skew:** 各个 lane 之间的传输线长度差异或者其他因素，会导致原本同时传输的多个并行比特，到达接收方的时间有所差异，这被称之为信号偏斜（signal skew）现象。接收方需要通过延迟信号较早到达的 lane，以对齐所有 lane 上的信号的到达时间，补偿 lane 之间信号传输快慢差异的问题。在协议规定的可允许的信号偏移范围内，（对于 2.5Gbps 速率来说，最大信号偏斜是 20ns)，接收方需要能够自动对偏移进行补偿。多 lane 间信号偏移补偿机制能够帮上 PCB 设计者一个大忙，因为他们不再需要设置复杂精细的约束，走出非常精确的等长信号传输线，有时候这是很难的。信号偏移补偿机制和极性翻转以及 lane 翻转机制一起，可以很大程度上简化高可靠的高速 PCIe PCB 设计。

  

### 14.2 链路训练中的字符序列

#### 14.2.1 概要

我们已经在字符序列这一章节讨论过物理层所有不同类型的字符序列。在训练过程中涉及到的物理层字符序列包括训练字符序列 TS1 以及 TS2 。图 14-4 中是 Gen1 以及 Gen2 模式下的字符序列格式。图 14-5 是 Gen3 模式中所使用字符序列的格式。接下来我们来进一步详细讨论他们。

![image-20211225215148969](img/14%20%E9%93%BE%E8%B7%AF%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%8E%E8%AE%AD%E7%BB%83/image-20211225215148969.png)

#### TS1 以及 TS2 字符序列

从图中可以看到，TS1/2 由 16 个符号组成。在 LTSSM 的轮询、配置以及恢复状态中，通信双方会交换 TS1/2 字符序列，本文会在后续的 LTSSM 章节详细讨论，后文分别在表 14-1/14-2中，用表格的形式描述了 TS1/2 16 个符号的具体含义。 

方便和便于理解起见，以下用 Gen1 表示速率为 2.5GT/s 的情况，Gen2 表示速率为 2.5GT/s 的情况，Gen3 表示速率为 8GT/s 的情况。另外值得注意的是，在低速率中，Link 以及 Lane 编号字段中的填充字符（PAD char acter）使用 K23.7 ，而在 Gen3 中使用的是 F7h。我们后续的讨论中不会特别在意两者的差异，因为这不重要。 

![image-20211225215638284](img/14%20%E9%93%BE%E8%B7%AF%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%8E%E8%AE%AD%E7%BB%83/image-20211225215638284.png)

表 14-1/14-2是 TS1 和 TS2 格式的大致描述，接下来我们仔细讨论下每个字段的含义。

- Symbol 0：
  - Gen1/2，所有字符序列的首个符号都是 K28.5(COM) 字符。接收方通过 COM 字符实现符号锁定。因为 COM 字符在所有 lane 上的发送的时间一致，因此用于多 lane 间补偿信号偏移也很有用。
  - Gen3，字符序列通过 Block 之前的 2 比特同步首部进行区分，之后的首个符号用于表示字符序列的类型。TS1 的首个符号是 1Eh, TS2 首个符号是 2Dh。
- Symbol 1（Link #）：
  - 链路编号，在轮询模式中使用填充字符填充。
- Symbol 2（Lane #）：
  - lane 编号，在轮询模式中使用填充字符填充。
- Symbol 3 (N_FTS):
  - Indicates the number of Fast Training Sequences the Receiver will need in order to achieve the L0 state when exiting from the L0s power state at the current speed. Transmitters will send at least that many FTSs to exit L0s. The amount of time needed for this depends on how many are needed and the data rate in use. For example, at 2.5 GT/s each Symbol takes 4ns so, if 200 FTSs were needed the required time would be 200 FTS * 4 Symbols per FTS * 4ns/Symbol = 3200 ns. If the Extended Synch bit is set in the transmitter device, a total of 4096 FTSs must be sent. This large number is intended to provide enough time for external Link monitoring tools to acquire Bit and Symbol Lock, since some of them may be slow in this regard.
- Symbol 4 (Rate ID): 
  - Devices report which data rates they support, along with a little more information used for hardware‐initiated bandwidth changes. The 2.5 GT/s rate must always be supported and the Link will always train to that speed automatically after reset so that newer components will remain backward compatible with older ones. If 8.0 GT/s is supported, it’s also required that 5.0 GT/s must be available. Other information in this Symbol includes the following: — Autonomous Change: If set, any requested bandwidth change was initi‐ ated for power‐management reasons. If a change is requested and this bit is not set, then unreliable operation has been detected at the higher speed or wider Link and the change is requested to fix that problem. — Selectable De‐emphasis – Upstream Ports set this to indicate their desired de‐emphasis level at 5.0 GT/s. How they make this choice is implementation specific. In the Recovery.RcvrCfg state, they register the value they receive for this bit internally (the spec describes it as being stored in a select_deemphasis variable). – Downstream Ports and Root Ports: In the Polling.Compliance state the select_deemphasis variable must be set to match the received value of this bit. In the Recovery.RcvrCfg state, the Transmitter sets this bit in its TS2s to match the Selectable De‐emphasis field in the Link Control 2 register. Since this register bit is hardware‐initialized, the expectation is that it’s assigned to an optimal value at power‐up by firmware or a strapping option. – In Loopback mode at 5.0 GT/s, the Slave de‐emphasis value is assigned by this bit in the TS1s sent by the Master. — Link Upconfigure Capability: Reports whether a wide Link whose width is reduced will be capable of going back to the wide case or not. If both sides of a Link report this during Configuration.Complete, this fact is recorded internally (e.g. an upconfigure_capable bit is set).
- Symbol 5 (Training Control): 
  - Communicates special conditions such as a Hot Reset, Enable Loopback mode, Disable Link, Disable Scrambling.
- Symbols 6‐9 (Equalization Control): 
  - — For Gen1 or Gen2, Symbols 7‐9 are just TS1 or TS2 indicators, and Symbol 6 usually is, too. However, if bit 7 of Symbol 6 is set to one instead of the zero that would be there for the TS1 or TS2 identifier, that indicates that this is an EQ TS1 or EQ TS2 sent from the Downstream Port (DSP ‐ port that faces downstream, like a Root Port). The “EQ” label stands for equal‐ ization, and means that the Link is going to change to 8.0 GT/s and so the Upstream Port (USP ‐ port that faces upstream, like an Endpoint Port) needs to know what equalizer values to use. For EQ TS1s or TS2s, Symbol 6 gives that information to the USP in the form of Transmitter Presets and Receiver Preset Hints. Ports that support 8.0 GT/s must accept either TS type (regular or EQ), but ports that do not support it are not required to accept the EQ type. The possible values for these presets are listed in Table 14‐8 on page 579 and Table 14‐9 on page 580. — For Gen3, Symbols 6‐9 provide Preset values and Coefficients for the Equalization process. Bit 7 of Symbol 6 in a TS2 can now be used by a USP to request that equalization be redone. If it does, bit 6 may also be set to indicate that the time needed to repeat the equalization process won’t cause problems, such as a completion timeout, as long as it’s done quickly (within 1ms of returning to L0). This might be needed, for example, if a problem was detected with the equalization results. A DSP can also use bits 6 and 7 to ask the USP to make such a request and guarantee no side effects, although the USP is not required to respond to this. For more on the equalization process, see “Link Equalization Overview” on page 577. • Symbols 10‐13: TS1 or TS2 identifiers. • Symbols 14‐15: (DC Balance) — For Gen1 and Gen2, these are just TS1 or TS2 indicators since DC Balance is maintained by 8b/10b encoding. — For Gen3, the contents of these two Symbols depend on the DC Balance of the Lane. Each Lane of a Transmitter must independently track the run‐ ning DC Balance for all the scrambled bits sent for TS1s and TS2s. “Run‐ ning DC Balance” means the difference between the number of ones sent vs. the number of zeroes sent, and Lanes must be capable of tracking a dif‐ ference of up to 511 in either direction. These counters saturate at their max value but continue to track reductions. For example, if the counter indi‐ cates that 511 more ones than zeroes have been sent, then no matter how many more ones are sent, the value will stay at 511. However, if 2 zeroes are sent, the counter will count down to 509. When a TS1 or TS2 is sent, the following algorithm is used to determine Symbols 14 and 15: – If the running DC Balance value is > 31 at the end of Symbol 11 and more ones have been sent, Symbol 14 = 20h and Symbol 15 = 08h. If more zeroes have been sent, Symbol 14 = DFh and Symbol 15 = F7h.

### 14.3 链路训练与状态控制状态机（LTSSM）

#### 14.3.1 概要

图 14-6 展示了 LTSSM 的高层次结构。每个 LTSSM 的状态中又划分为若干子状态。在基础复位（Fundmental Reset），即冷复位（Cold Reset）和暖复位（Warm Reset），或者热复位（Hot Reset）释放后，进入的第一个状态是 Detect 状态。

LTSSM 总共有 11 个顶层状态，（所谓的顶层状态，即与顶层状态下的子状态区分），他们分别是：

- Detect
- Polling
- Configuration
- Recovery
- L0、L0s、L1、L2
- Hot Reset
- Loopback
- Disable

他们可以划分为五大类：

- 链路训练状态
- 重训练状态，即 Recovery
- 软件驱动的电源管理状态
- 主动电源管理（ASPM，Active-State Power Management）状态（即硬件驱动的电源管理状态）
- 其他状态

在任意复位释放后，LTSSM 即进入了**训练类状态**（Link Training states），一切正常的话，会按照 Detect => Polling => Configuration => L0 的顺序跳转状态。待进入 L0 状态后，即可以进行正常的数据报文收发操作。

进入**链路重训练状态**，也即是链路恢复（Recovery） 状态的原因很多，比如从像 L1 这样的**低功耗链路状态（low-power Link state）**中恢复，或者正准备进行链路带宽切换（速率或者位宽切换）。在链路重训练状态中，链路会重复类似于训练状态的操作，来解决链路中的问题，并最终回到 L0，这一正常工作的状态。

设备中的功耗管理软件在进入**低功耗设备状态（low-power device state）**后，比如 D1、D2、D3Hot 或者 D3Cold 之后，会强制链路进入**低功耗软件管理链路状态（low-power Management Link state）**，比如 L1 或者 L2 。

译注：注意区分这里的**低功耗设备状态（low-power device state）**与**低功耗链路状态（low-power Link state）**

如果链路上很长时间都没有报文需要发送，ASPM 硬件逻辑会使链路自动进入低功耗 **ASPM 状态**（low-power ASPM Link state），比如 L0s 或者 ASPM L1。

此外，软件可以直接使链路进入一些其他状态，比如禁用状态（Disabled），回环状态（Loopback）或者热复位（Hot Reset）状态。这里，这些状态被归纳为**其他状态**。

![image-20220105205407630](img/14%20%E9%93%BE%E8%B7%AF%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%8E%E8%AE%AD%E7%BB%83/image-20220105205407630.png)

图 14-6 LTSSM 状态跳转图

#### 14.3.2 LTSSM 状态概要（链路训练与状态状态机状态概要）

以下是对 11 个 LTSSM 状态的高层次概要介绍。

- **检测状态 Detect:** 复位释放后进入的初始状态。在这个状态中，本方设备从电气特性的角度入手，检测链路对端设备是否存在。在穿行传输的领域中，这种检测对端的特性是不寻常的，但是设置 Detect 状态的目的在于增加测试的便利性（It's done to facilitate testing），我们将在 Detect 之后的 Polling 阶段验证这一观点。除了复位释放之外，还可能从别的 LTSSM 状态进入 Detect。

- **轮询状态 Polling：**在轮询状态中，发送方将以 2.5Gbps 的速率向对端发送 TS1 以及 TS2 序列，使用协议最低速率以实现对早期协议的后向兼容。接收端可以使用接收的 TS1/2 序列实现以下功能：

  - 完成位锁定
  - 完成符号锁定或者块锁定（Gen3）
  - 如有必要，校正通道极性翻转
  - 学习可实现的链路数据速率
  - 在测试条件下，发起兼容性测试序列：之所以能够进入兼容性测试模式，是因为如果一个接收方在 Detect 阶段能够被识别，但是没有返回任何流量，链路能够凭借这个现象将对端识别为一个测试负载（Test load）。在识别对端为测试负载后，发送方会发送特定的兼容测试图样（Pattern），以方便测试。这项特性能够使测试设备快速地验证链路的电压、BER（Bit Error Ratio）、时序以及其他指标在链路容忍范围之内。

- **配置状态 Configuration：**上游（Upstream）和下游（Downstream）器件将分别按照他们上下游的角色，以 2.5Gbps 速率，交换 TS1 和 TS2 序列，来实现以下的目标：

  - 协商决定链路的宽度
  - 为各通道指派编号
  - 检测通道是否需要顺序或者极性交换，在本地恢复这些交换
  - 补偿各个通道之间的时序偏斜

  从这个状态开始，可以关闭扰码（Scrambling can be disabled），并可进入 Disable 或者 Loopback 状态。此外，会记录在 TS1 和 TS2 序列之间，从 L0s 状态进入 L0 状态所需的 FTS 序列数量。

- **L0 状态：**

![image-20220105215954695](img/14%20%E9%93%BE%E8%B7%AF%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%8E%E8%AE%AD%E7%BB%83/image-20220105215954695.png)
