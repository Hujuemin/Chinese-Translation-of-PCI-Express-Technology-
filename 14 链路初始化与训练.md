# Chpater 14 Link Initialization & Training//链路初始化与训练

### 关于前一章

上一章描述了物理层电与链路的电气接口，包括差分发送器与接收器的一些底层特性。同时也讨论了信号均衡的需求以及均衡的方法。上一章中分别讨论了 Gen1, Gen2 和 Gen3 速度等级下的差分发送与接收器的特性。

### 关于本章 

 本章讨论物理层链路训练与状态状态机（LTSSM, Link Traning and Status State Machine）的行为，包括从上电开始，到正常报文流量开始的整个初始化过程。此外，本章还将讨论链路电源状态 L0s,L1,L2,L3 以及这些状态之间的转换。本章也会讨论恢复机制（Recovery），重新完成位锁定（Bit Lock）、符号锁定（Symbol Lock）或者块锁定（Block Lock）的过程。最后，还讨论了用于链路带宽管理的链路速率以及位宽转换。

### 关于下一章

下一章将讨论 PCIe 端口或者链路中存在的错误类型，如何检测、报告这些错误，以及这些错误的处理选项。因为 PCIe 设计中后向兼容了 PCI 的错误报告机制，所以将介绍 PCI 的错误处理机制作为背景知识。然后我们将关注于PCIe 对于可纠正、非致命以及致命错误的处理机制。

### 总览

链路初始化和训练是由物理层控制的，基于硬件 (而非软件) 的过程。该过程配置和初始化设备的链路和端口，使链路上能够进行正常的数据报文通信。

![图 14-1 LTSSM 所处的位置](img/14%20%E9%93%BE%E8%B7%AF%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%8E%E8%AE%AD%E7%BB%83/image-20211221215807738.png)

完整的训练过程在复位后由硬件自动启动，并由 LTSSM 管理，如 506 页图14-1 所示。在链路初始化和训练过程中包括了几项步骤。让我们思考下它们都有哪些作用，并提前引入一些术语。

- **位锁定，Bit Lock**：当链路训练开始时，接收器的时钟尚未与接收信号的发送时钟同步，无法可靠地采样输入信号的数据比特。在链路训练期间，接收器的**时钟和数据恢复**（CDR，Clock and Data Recovery）逻辑通过使用数据比特流作为时钟的参考信号，来重建发送器的时钟。一旦从数据流中恢复了时钟，就可以说接收器已经完成了位锁定，然后能够正确地采样输入数据比特。有关位锁定机制的更多信息，可以参阅第 395 页的“实现位锁定”。

- **符号锁定，Symbol Lock**：对于8b/10b编码 (Gen1/Gen2)而言，训练的下一步是进行符号锁定。同位锁定类似，虽然接收器目前可以识别单个比特的极性，但是不知道由 10 个比特组成的，符号的边界在哪里。当发送接收端的 TS1 和 TS2 序列进行交换时，接收器在比特流中搜索可识别的符号。COM 符号是用符号识别目的的一个简单符号。COM 符号独特的编码使得它很容易识别，在 TS1 和 TS2 序列的交换过程中，COM 字符到达并被识别后，意味着接收方定位到了两个符号之间的边界，以及两个序列之间的边界。有关这方面的更多信息，参见第 396 页的“实现符号锁定”。

- **块锁定，Block Lock**：对于8.0 GT/s(Gen3) 所使用的块锁定，处理过程与符号锁定略有不同，因为没有使用8b/10b 编码方案，所以也就不存在 COM 字符。然而，接收器仍然需要在接收比特流中找到可识别的报文边界。解决方案是在训练序列中包含更多的电气空闲退出序列（ EIEOS,Electrical Idle Exit Ordered Set)，用于定位边界。EIEOS 可以被识别为 00h 和 FFh 字节交替的序列，并且其位置定义了块之间的边界，因为根据协议，当该序列结束时，下一个块必须开始。

- **链路宽度，Link Width**：具有多个通道的 PCIe 设备可以使用不同的链路宽度。例如，具有 x2 端口的设备可以与 x4 端口的设备连接。在链路训练期间，两台设备的物理层会测试链路，并将链路宽度设置为两者能接受的最大值。

- **通道反转， Lane Reversal**：设备端口上的多个通道从 0 开始，按递增顺序编号。通常来说，端口的通道 0 同样连接到对端的通道 0，通道 1 连接到通道 1 ，依此类推。

  然而，有时我们希望能够在逻辑上，颠倒各个通道间的编号，以简化 PCB 布线。并且能够允许各个通道间的连接走线不必交叉(参见第 508 页的图 14-2)。只要其中一个 PCIe 设备支持通道编号反转功能，这是一项可选功能，就可以颠倒通道的连接关系。

  通道连接颠倒的情况是在链路训练期间检测到的，其后，其中一台设备必须在内部颠倒其通道编号才能使链路正常工作。由于规范没有强制要求支持此功能，电路板设计人员需要保证系统中至少有一个设备支持此功能，才能颠倒通道顺序布线。

![image-20211221225619507](img/14%20%E9%93%BE%E8%B7%AF%E5%88%9D%E5%A7%8B%E5%8C%96%E4%B8%8E%E8%AE%AD%E7%BB%83/image-20211221225619507.png)

